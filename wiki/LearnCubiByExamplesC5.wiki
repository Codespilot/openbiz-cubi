#summary Learn Cubi By Examples Chapter 5 - Ticket Comments and History

= Learn Cubi By Examples Chapter 5 - Ticket Comments and History =
At the end of previous chapter, we enhanced ticket list form by adding table join, as well as edit form by binding data to form elements. This chapter will add user comments and change history in ticket detail page.

== Have a Separate Ticket Detail Page ==
By far, all ticket forms are organized in one page - the ticket list view. In real world, people like to have a separate page displaying individual ticket information such that this page can be bookmarked and forwarded in email. 

=== Create Ticket Detail View ===
To make a new view, we simply copy trac/view/TicketListView.xml to trac/view/TicketDetailView.xml. Then edit the content to
{{{
<?xml version="1.0" standalone="no"?>
<EasyView Name="TicketDetailView" Description="Ticket details" Class="EasyView" Tab="" TemplateEngine="Smarty" TemplateFile="view.tpl" Access="trac.ticket.Access">
   <FormReferences>
       <Reference Name="trac.ticket.form.TicketDetailForm"/>
   </FormReferences>
</EasyView>
}}}

Then change navigation links in ticket list form to the ticket detail view. We modify the "fld_Id" and "fld_summary" element in trac/ticket/form/TicketListForm.xml
{{{
<Element Name="fld_Id" Class="ColumnText" FieldName="Id" Label="Id" Sortable="Y" AllowURLParam="N"/>
<Element Name="fld_summary" Class="ColumnText" FieldName="summary" Link="{@home:url}/trac/ticket_detail/{@:Elem[fld_Id].Value}" Label="Summary" Required="Y"/>
}}}
Here we add a link attribute to summary element and remove the onclick action on Id element.

Now if you reload the ticket list view, then click on the summary link, you would see a separate ticket detail page with url like http://host/cubi/index.php/trac/ticket_detail/1

=== Add Ticket Change History ===
One of the key requirements of tracking the ticket change is to record and display all ticket change history. Whenever a change is made to a ticket, we want to record
 * When and Who made the change
 * Which fields were change. What are the old and new values
 * Any comment was added

As mentioned in Chapter 1, table "trac_comments" is used to store ticket's comments and changes that are put in a serialized string in 'comments' column.

Again, we can use "gen_meta" script to generate comments metadata. 
{{{
php gen_meta.php Default trac_comments trac.comments
}}}
Because ticket comments doesn't need a separate page, the view creation, access control and mod.xml change are skipped in metadata generation wizard. Then open trac/comments/do/CommentsDO.xml and edit it as
{{{
<?xml version="1.0" standalone="no"?>
<BizDataObj Name="CommentsDO" Description="" Class="BizDataObj" DBName="Default" Table="trac_comments" SearchRule="" SortRule="[time] DESC" OtherSQLRule="" Uniqueness="" Stateless="N" IdGeneration="Identity" CacheLifeTime="0">
    <BizFieldList>
        <BizField Name="Id" Column="id" Type="Number"/>
        <BizField Name="parent_id" Column="parent_id" Length="30" Required="Y" Type="Text"/>
        <BizField Name="time" Column="create_time" Required="N" Type="Datetime" ValueOnCreate="{date('Y-m-d H:i:s')}"/>
        <BizField Name="author_id" Column="author_id" Type="Number" ValueOnCreate="{@profile:Id}"/>
        <BizField Name="author" Join="user" Column="username" Type="Text" Required="N"/>
        <BizField Name="comments" Column="comments" Required="N" Type="Text"/>
    </BizFieldList>
    <TableJoins>
        <Join Name="user" Table="user" Column="id" ColumnRef="author_id" JoinType="LEFT JOIN"/></TableJoins>
    <ObjReferences>
    </ObjReferences>
</BizDataObj>
}}}

Please note that a table join is added so that the comment data object can have author username.

Now we can add the newly added comments list form to ticket detail view. 
{{{
<?xml version="1.0" standalone="no"?>
<EasyView Name="TicketDetailView" Description="Ticket details" Class="EasyView" Tab="" TemplateEngine="Smarty" TemplateFile="view.tpl" Access="trac.ticket.Access">
   <FormReferences>
       <Reference Name="trac.ticket.form.TicketDetailForm"/>
       <Reference Name="trac.comments.form.CommentsListForm"/>
   </FormReferences>
</EasyView>
}}}

The ticket detail looks like

http://openbiz-cubi.googlecode.com/svn/trunk/docs/img/learnbyexamples/trac_ticketdetail1.png

== Customize Form Logic ==
The just created comment list form obviously is not what we expect to see in ticket change history. We want to resolve two things:
 # How to save the change history from ticket record change into a serialized string in comments table.
 # How to display the serialize comment string into an easy understandable format.

Also we want to send a notification email of ticket creation or change to ticket owners.

These logic cannot be covered in core Openbiz-Cubi EasyForm class. Thus Cubi recommends implementing a custom class extending from EasyForm class.

=== Ticket Form ===
To have an user-defined class (TicketForm class), we simply do
 * make a new file called TicketForm.php under /trac/ticket/form/, the same directory of TicketListForm.xml.
 * extend TicketForm from EasyForm class.
 * change the "Class" attribute in Ticket form xml files to "TicketForm".
 * then fill in the custom logic in methods.

As there is special logic in ticket "save" actions, we override _doInsert and _doUpdate methods in TicketForm.
{{{
<?php
include_once (MODULE_PATH.'/trac/email/TicketEmailService.php');

class TicketForm extends EasyForm 
{ 
   	protected $commentsDOName = "trac.comments.do.CommentsDO";
   	protected $versionDOName = "trac.version.do.VersionDO";
   	protected $milestoneDOName = "trac.milestone.do.MilestoneDO";
   	protected $productDOName = "trac.product.do.ProductDO";
   	protected $componentDOName = "trac.component.do.ComponentDO";
   	protected $userDOName = "system.do.UserDO";
   	
   	protected $ticketEmailSvc = "trac.email.TicketEmailService";
   	
   	protected function _doInsert($inputRecord)
   	{
        $emailSvc = BizSystem::getObject($this->ticketEmailSvc);
        
        parent::_doInsert($inputRecord);
        
        $ticketRec = $this->getActiveRecord($ticket_id);
        
        // send email to ticket owner and cc
        $emailSvc->notifyNewTicket($ticketRec);
        
        return true;
   	}
   
   	protected function _doUpdate($inputRecord, $currentRecord)
   	{
        $emailSvc = BizSystem::getObject($this->ticketEmailSvc);
        
        parent::_doUpdate($inputRecord, $currentRecord);
        
        // get audit dataobj
        $commentsDO = BizSystem::getObject($this->commentsDOName);
        if (!$commentsDO) {
            return;
        }
        $ticket_id = $currentRecord['Id'];
        
        // compose the comments data in serialized array field=>(oldval, newval)
        $data = array();
        
        // reform the record so that the history doesn't include change of field_id
        $this->reformRecord($inputRecord, $currentRecord);
        
        foreach ($inputRecord as $fldName=>$fldVal)
        {
            $oldVal = $currentRecord[$fldName];
            if ($oldVal == $fldVal)
                continue;
            
            $data[$fldName] = array('old'=>$oldVal, 'new'=>$fldVal);
        }
        $comment = BizSystem::clientProxy()->getFormInputs("fld_comments");
        if (!empty($comment))
            $data['comment'] = $comment;
        
        if (empty($data))
            return;
        
        // save to comment do
        $dataRec = new DataRecord(null, $commentsDO); 
        $dataRec['parent_id'] = $ticket_id;
        $dataRec['comments'] = serialize($data);
        try {
            $dataRec->save();
        }
        catch (BDOException $e)
        {
            $this->processBDOException($e);
            return;
        }
        
        $ticketRec = $this->getActiveRecord($ticket_id);
        
        $this->runEventLog();
        
        // send email to ticket owner and cc
        $commentRec['author_id'] = $dataRec['author_id'];
        $commentRec['time'] = $dataRec['time'];
        $commentRec['changes'] = $data;
        $emailSvc->notifyChangeTicket($ticketRec, $commentRec);
        
        return true;
   	}

   	// special logic for version_id, product_id, component_id, milestone_id, owner_id
   	// get the field name value and append it in the array
   	protected function reformRecord(&$inputRecord, $currentRecord)
   	{
        // version_id. 
        if ($inputRecord['version_id']!=$currentRecord['version_id']) {
            $versionDO = BizSystem::getObject($this->versionDOName);
            $version = $versionDO->fetchById($inputRecord['version_id']);
            $inputRecord['version'] = $version['name'];
            unset($inputRecord['version_id']);
        }
        
        // milestone_id
        if ($inputRecord['milestone_id']!=$currentRecord['milestone_id']) {
            $milestoneDO = BizSystem::getObject($this->milestoneDOName);
            $milestone = $milestoneDO->fetchById($inputRecord['milestone_id']);
            $inputRecord['milestone'] = $milestone['name'];
            unset($inputRecord['milestone_id']);
        }
        
        // product_id
        if ($inputRecord['product_id']!=$currentRecord['product_id']) {
            $productDO = BizSystem::getObject($this->productDOName);
            $product = $productDO->fetchById($inputRecord['product_id']);
            $inputRecord['product'] = $product['name'];
            unset($inputRecord['product_id']);
        }
        
        // component_id
        if ($inputRecord['component_id']!=$currentRecord['component_id']) {
            $componentDO = BizSystem::getObject($this->componentDOName);
            $component = $componentDO->fetchById($inputRecord['component_id']);
            $inputRecord['component'] = $component['name'];
            unset($inputRecord['component_id']);
        }
        
        // owner_id
        unset($inputRecord['owner_id']);
    }
}
?>
}}}
