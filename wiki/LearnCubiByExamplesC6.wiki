#summary Learn Cubi By Examples Chapter 6 - Add Ticket Attachment

= Learn Cubi By Examples Chapter 6 - Add Ticket Attachment =
At the end of previous chapter, we added change history in ticket detail page, learned how to write a custom form class and custom template. This chapter will add support for attaching files to a ticket.

== Use Cubi Attachment Form ==
One of the key requirements of ticket is to allow users to attach files to a ticket. Uploading a file seems an easy task, while it can be very complicated when you want to have the cool UI like attach file in gmail. Basically the good uploader can
 * Allow more than one files selection in one upload
 * Be able to show the upload progress

Fortunately, Cubi attachment module has all these built-in. One of the best parts of Cubi platform is its core and applications are all modules. All modules can share other module classes and be shared by other modules. So we can simple leverage the functionality provided by attachment module for attaching files to tickets.

=== Ticket Attachment Form ===
The easiest way of programming is "copy". Let's copy /attachment/widget/AttachmentListEditForm.xml to /trac/ticket/form/TicketAttachmentForm.xml and edit it.
{{{
<?xml version="1.0" encoding="UTF-8"?>
<EasyForm Name="TicketAttachmentForm" Class="attachment.widget.AttachmentForm" FormType="List" Title="Ticket Attachments" jsClass="jbForm" BizDataObj="attachment.do.AttachmentDO"   PageSize="10" DefaultForm="Y" TemplateEngine="Smarty" TemplateFile="grid.tpl"  Access="attachment.access">
    <DataPanel>
        <Element Name="row_selections" Class="RowCheckbox" width="20"  Label="" FieldName="Id"/>        
        <Element Name="fld_Id" Class="Hidden" Hidden="Y" FieldName="Id" Label="Id" />
        <Element Name="fld_icon" Class="ColumnImage" Text="{RESOURCE_URL}/attachment/images/icon_attachment_private.png" FieldName="" Label="Type">				
        </Element>
        <Element Name="fld_title" Class="ColumnText" FieldName="title" Label="Title"  Sortable="Y" Link="javascript:">         
            <EventHandler Name="add_onclick" Event="onclick" Function="LoadDialog(attachment.widget.AttachmentDetailForm,{@:Elem[fld_Id].Value})"/>        
        </Element>
        <Element Name="fld_filename" Class="ColumnText" FieldName="filename" Label="Filename" Sortable="Y" ></Element>
        <Element Name="fld_filesize" Class="ColumnText" FieldName="filesize" Text="{@util:format_bytes(@:Elem[fld_filesize].Value)}"  Label="Filesize" Sortable="Y" ></Element>		
        <Element Name="fld_create_time" Class="ColumnText" FieldName="create_time" Label="Timestamp"  Sortable="Y" ></Element>
        <Element Name="fld_download" Class="ColumnText" FieldName="download_count" Label="Downloads" Sortable="Y" ></Element>
    </DataPanel>
    <ActionPanel>
        <Element Name="btn_add" Class="Button" text="Add" CssClass="button_gray_add">
            <EventHandler Name="add_onclick" Event="onclick" Function="LoadDialog(attachment.widget.AttachmentNewForm)"/>
        </Element>
        <Element Name="btn_edit" Class="Button" text="Edit" CssClass="button_gray_m">
            <EventHandler Name="delete_onclick" Event="onclick" Function="LoadDialog(attachment.widget.AttachmentEditForm)"/>
        </Element>
        <Element Name="btn_delete" Class="Button" text="Delete" CssClass="button_gray_m">
            <EventHandler Name="delete_onclick" Event="onclick" Function="DeleteRecord()"/>
        </Element> 
    </ActionPanel> 
    <NavPanel>
    </NavPanel> 
</EasyForm>
}}}

Then we add this new form into TicketDetailView.xml
{{{
<?xml version="1.0" standalone="no"?>
<EasyView Name="TicketDetailView" Description="Ticket details" Class="EasyView" Tab="" TemplateEngine="Smarty" TemplateFile="ticket_detail_view.tpl" Access="trac.ticket.Access">
   <FormReferences>
       <Reference Name="trac.ticket.form.TicketDetailForm"/>
       <Reference Name="trac.comments.form.CommentsListForm"/>
       <Reference Name="trac.ticket.form.TicketAttachmentForm"/>
   </FormReferences>
</EasyView>
}}}

Reload Ticket detail view, the ticket attachment form should be added in the bottom.

http://openbiz-cubi.googlecode.com/svn/trunk/docs/img/learnbyexamples/trac_ticketattach3.png

Click on Add button to popup the file upload dialog. Click on "Select Files" button to select files to upload. 

http://openbiz-cubi.googlecode.com/svn/trunk/docs/img/learnbyexamples/trac_ticketattach0.png

On the ticket attachment form, click on the file name will popup attachment detail dialog. Click on "Download" button to download the file. You can see the "Downloads" column in the attachment form changes accordingly.

http://openbiz-cubi.googlecode.com/svn/trunk/docs/img/learnbyexamples/trac_ticketattach1.png

== Have Attachment Template File ==
The ticket attachment UI is a standard Cubi list form. But we want the attachments to be displayed in a multi-line list instead of table grid. Thus we point a template file "ticket_attach.tpl" to the TicketAttachmentForm.xml.
{{{
<?xml version="1.0" encoding="UTF-8"?>
<EasyForm Name="TicketAttachmentForm" Class="attachment.widget.AttachmentForm" FormType="List" Title="Ticket Attachments" jsClass="Openbiz.Form" BizDataObj="attachment.do.AttachmentDO"   PageSize="10" DefaultForm="Y" TemplateEngine="Smarty" TemplateFile="ticket_attach.tpl"  Access="attachment.access">
    <DataPanel>
        <Element Name="row_selections" Class="RowCheckbox" width="20"  Label="" FieldName="Id"/>        
        <Element Name="fld_Id" Class="Hidden" Hidden="Y" FieldName="Id" Label="Id" />
        <Element Name="fld_icon" Class="ColumnImage" Text="{RESOURCE_URL}/attachment/images/icon_attachment_private.png" FieldName="" Label="Type">				
        </Element>
        <Element Name="fld_title" Class="ColumnText" FieldName="title" Label="Title" Link="javascript:">         
            <EventHandler Name="add_onclick" Event="onclick" Function="LoadDialog(attachment.widget.AttachmentDetailForm,{@:Elem[fld_Id].Value})"/>        
        </Element>
        <Element Name="fld_filename" Class="ColumnText" FieldName="filename" Label="Filename" ></Element>
        <Element Name="fld_filesize" Class="ColumnText" FieldName="filesize" Text="{@util:format_bytes(@:Elem[fld_filesize].Value)}"  Label="Filesize" ></Element>	
        <Element Name="fld_description" Class="ColumnText" FieldName="description" Label="Description" />        
        <Element Name="fld_create_time" Class="ColumnText" FieldName="create_time" Label="Timestamp"></Element>
        <Element Name="fld_create_by" Class="ColumnText" FieldName="create_by" Label="Create By" Text="{BizSystem::GetProfileName(@:Elem[create_by].Value)}"/>
        <Element Name="fld_download" Class="ColumnText" FieldName="download_count" Label="Downloads"></Element>
    </DataPanel>
    <ActionPanel>
        <Element Name="btn_add" Class="Button" text="Add" CssClass="button_gray_add">
            <EventHandler Name="add_onclick" Event="onclick" Function="LoadDialog(attachment.widget.AttachmentNewForm)"/>
        </Element>
    </ActionPanel> 
    <NavPanel>
    </NavPanel> 
</EasyForm>
}}}

Then create a trac_attach.tpl under /trac/template/.
{{{
<form id='{$form.name}' name='{$form.name}'>
<div style="padding-left:25px;padding-right:40px;">
    <div>
    {if $form.icon !='' }
    <div class="form_icon"><img  src="{$image_url}/{$form.icon}" border="0" /></div>
    {/if}
    <h2>
    {$form.title}
    </h2> 
    {if $form.description !='' }
    <p class="form_desc">{$form.description}</p>
    {/if}
    </div>

    {foreach item=row from=$dataPanel.data}
    <table style="margin-left:10px; margin-bottom:5px">
    <tr>
    <td valign="top">{$row.fld_icon}</td>
    <td valign="top">{$row.fld_title} ({$row.fld_filename}, {$row.fld_filesize} bytes) 
    <p>uploaded by {$row.fld_create_by} on {$row.fld_create_time}.</p>
    <p><i>{$row.fld_description}</i></p>
    </td>
	</tr>
    </table>
    {/foreach}
  
    <div>	
    <div class="action_panel">
    {foreach item=elem from=$actionPanel}
        {$elem.element}
    {/foreach}
    </div>
    </div>
    <div class="v_spacer" style="clear:both"></div>
</div>

</form>
}}}

The attachment form now looks as

http://openbiz-cubi.googlecode.com/svn/trunk/docs/img/learnbyexamples/trac_ticketattach4.png

So far the three forms in ticket detail page work well individually. While we really want to 
 * only show change history of the given ticket
 * only show attachment files of the given ticket

The [LearnCubiByExamplesC7 next chapter] will answer how to enforce parent-child relationship between forms.